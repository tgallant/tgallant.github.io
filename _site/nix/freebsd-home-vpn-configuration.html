<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>tgallant.github.io</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <!-- Place favicon.ico and apple-touch-icon.png in the root directory -->
    <link href="//fonts.googleapis.com/css?family=Inconsolata:400,300,700" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="/bower_components/pure/pure-min.css">
    <link rel="stylesheet" href="/bower_components/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/css/main.css">
    <script src="/bower_components/modernizr/modernizr.js"></script>
    <link rel="stylesheet" href="/bower_components/highlight.js/src/styles/github.css">
    <script src="/bower_components/highlight.js/src/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
  </head>
  <body>
    <!--[if lt IE 7]>
        <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
        <![endif]-->












<div class="content">
  <a href="/" class="button-xsmall pure-button">Home</a>
  <a href="/euler/" class="button-xsmall pure-button">Euler</a>
  <a href="/resources/" class="button-xsmall pure-button">Resources</a>

  <div class="header">
    <h2>FreeBSD Home VPN Client Configuration</h2>
    <p><i><a href="https://twitter.com/timgallant">@timgallant</a></i></p>
  </div>
  <p><strong>[Note]: Jump <a href="#pf">here</a> if you can't access your computer outside
  of your network with VPN running</strong></p>

<p>In this post I will walk through the steps of setting up a VPN client on
your FreeBSD desktop/home server. This tutorial assumes that you have
a VPN provider. If you don't have one, I recommend
<a href="https://privateinternetaccess.com">privateinternetaccess</a>.</p>

<h1>OpenVPN</h1>

<p>To install OpenVPN, run the following command:</p>

<pre><code>sudo portmaster security/openvpn
</code></pre>

<p>Add the following lines to your <code>/etc/rc.conf</code>:</p>

<pre><code>openvpn_configfile="/usr/local/etc/openvpn/uswest.ovpn"
openvpn_enable="YES"
</code></pre>

<p>The first line sets the path for the OpenVPN config file. Change the
path to meet your needs. I recommend copying the config file
provided by your VPN service to <code>/usr/local/etc/openvpn/</code>. The second
line sets OpenVPN to start at boot time.</p>

<p>Next, start OpenVPN and enter in your credentials:</p>

<pre><code>sudo service openvpn start
</code></pre>

<p>At this point, OpenVPN should be started. You can verify by going to
<a href="http://canihazip.com">canihazip.com</a>. The IP address it shows should
be different than your home IP.</p>

<p>If you are setting this up on a headless server, you can verify the
VPN is running by executing the following:</p>

<pre><code>curl http://canihazip.com/s
</code></pre>

<p><a name="pf"></a></p>

<h1>PF</h1>

<p>All outbound traffic should now be going through the VPN tunnel. One
drawback of this is that any response to server requests via
your home IP will be routed through the VPN tunnel. This means that
you won't be able to access this computer from outside of your
network. If you want to be able to SSH into your box or utilize any
other service, you'll have to add some PF commands.</p>

<p>If you already have a <code>pf.config</code>, add the following were <code>$ext_if</code> is
your physical interface and <code>$ext_gw</code> is the internal IP of your router:</p>

<pre><code>pass in quick on $ext_if reply-to($ext_if $ext_gw) proto icmp to $int_ip keep state
pass in quick on $ext_if reply-to($ext_if $ext_gw) proto tcp to $int_ip port 22 keep state
pass in on $ext_if reply-to($ext_if $ext_gw) to $int_ip keep state
</code></pre>

<p>This configuration will allow your server to respond to pings and
accept SSH connections through your home IP. Copy the second line and
change the port if you want to open other ports.</p>

<p>If you don't have a config, copy the file below and paste it in
<code>/etc/pf.conf</code>. Make sure the interface names match for your system.
For <code>$ext_gw</code> use the internal IP of your router and for $int_ip use
the internal IP address of your computer.</p>

<pre><code>
# vim: set ft=pf
# /etc/pf.conf

ext_if = "em0" # physical interface
tun_if = "tun0" # vpn tunnel interface
ext_gw = "xxx.xxx.xxx.xxx" # ip address of the router
int_ip = "xxx.xxx.xxx.xxx" # ip address of this machine

icmp_types_ext_if="{ echoreq }" # ping

set loginterface $ext_if

### normalization
scrub in all random-id fragment reassemble

set skip on lo0

block return in log all
block out all

antispoof quick for $ext_if

### block anything coming from sources that we have no back routes for.
block in from no-route to any

block in from urpf-failed to any

### drop broadcast requests quietly.
block in quick on $ext_if from any to 255.255.255.255
block in quick on $ext_if proto tcp flags FUP/WEUAPRSF
block in quick on $ext_if proto tcp flags WEUAPRSF/WEUAPRSF
block in quick on $ext_if proto tcp flags SRAFU/WEUAPRSF
block in quick on $ext_if proto tcp flags /WEUAPRSF
block in quick on $ext_if proto tcp flags SR/SR
block in quick on $ext_if proto tcp flags SF/SF

### allow outbound traffic
pass out on $ext_if proto { tcp, udp, icmp } from any to any modulate state
pass out on $tun_if proto { tcp, udp, icmp } from any to any modulate state

### allow inbound traffic, routing responses to the physical interface
pass in quick on $ext_if reply-to($ext_if $ext_gw) proto icmp to $int_ip keep state
pass in quick on $ext_if reply-to($ext_if $ext_gw) proto tcp to $int_ip port 22 keep state
pass in on $ext_if reply-to($ext_if $ext_gw) to $int_ip keep state
</code></pre>


<p>Now we'll have to enable pf and start the service. To
enable pf, run:</p>

<pre><code>sudo echo 'pf_enable="YES"' &gt;&gt; /etc/rc.conf
</code></pre>

<p>To start pf, run:</p>

<pre><code>sudo service pf start
</code></pre>

<p>You should now have a working VPN connection and a pf configuration
that allows you to access this computer from outside your
network. If you have any comments or questions, let me know below.</p>

</div>

<div id="disqus_thread" class="content"></div>
<script type="text/javascript">
  /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  var disqus_shortname = 'schemerocks'; // required: replace example with your forum shortname
  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

    <script src="/bower_components/jquery/dist/jquery.min.js"></script>
    <script src="/js/main.js"></script>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-56332741-1', 'auto');
      ga('send', 'pageview');

    </script>
  </body>
</html>

